var _contentScript={highlightClassName:null,init:function(){"use strict";_contentScript.highlightClassName=_stringUtils.createUUID({beginWithLetter:!0}),chrome.storage.onChanged.addListener(_contentScript.onStorageChanged),_contentScript.resetStylesheetHighlightStyle(),chrome.runtime.onMessage.addListener(_contentScript.onRuntimeMessage)},isSelectionCollapsed:function(){"use strict";return window.getSelection().isCollapsed},getSelectionRange:function(){"use strict";var range,selection=window.getSelection();return selection.isCollapsed?(range=new Range,range.collapse(!1)):range=selection.getRangeAt(0),range},createHighlight:function(xpathRange,id,className){"use strict";var range;try{range=_xpath.createRangeFromXPathRange(xpathRange)}catch(err){return null}return range?_highlighter.create(range,id,[_contentScript.highlightClassName,className]):null},deleteHighlight:function(id){"use strict";return _highlighter.del(id)},selectHighlight:function(id){"use strict";var selection=window.getSelection();if(selection.removeAllRanges(),id){var range=_highlighter.getRange(id);return selection.addRange(range),range}},isHighlightInDOM:function(id){"use strict";return 1===$("#"+id).length},updateHighlight:function(id,className){"use strict";return _highlighter.update(id,[_contentScript.highlightClassName,className])},scrollTo:function(selector){"use strict";var $elm=$(selector);return $elm&&$("body").animate({scrollTop:$elm.offset().top},"slow"),null!==$elm},onRuntimeMessage:function(message,sender,sendResponse){"use strict";var response;switch(message.id){case"create_highlight":response=null!==_contentScript.createHighlight(message.range,message.highlightId,message.className);break;case"update_highlight":response=_contentScript.updateHighlight(message.highlightId,message.className);break;case"delete_highlight":response=_contentScript.deleteHighlight(message.highlightId);break;case"select_highlight":range=_contentScript.selectHighlight(message.highlightId),message.highlightId&&(response=_xpath.createXPathRangeFromRange(range));break;case"is_highlight_in_dom":response=_contentScript.isHighlightInDOM(message.highlightId);break;case"get_selection_range":response=_xpath.createXPathRangeFromRange(_contentScript.getSelectionRange());break;case"get_range_text":var range=_xpath.createRangeFromXPathRange(message.range);response=range?range.toString():null;break;case"scroll_to":response=_contentScript.scrollTo("#"+message.fragment);break;default:throw"unhandled message: sender="+sender+", id="+message.id}sendResponse(response)},_getHighlightId:function(element){"use strict";if(element.firstSpan)return element.firstSpan.id},onMouseEnterHighlight:function(){"use strict";var id=_contentScript._getHighlightId(this);id&&chrome.runtime.sendMessage({id:"on_mouse_enter_highlight",highlightId:id})},onMouseLeaveHighlight:function(){"use strict";chrome.runtime.sendMessage({id:"on_mouse_leave_highlight"})},onStorageChanged:function(changes,namespace){"use strict";if("sync"===namespace){if(changes.sharedHighlightStyle){var c1=changes.sharedHighlightStyle;c1.oldValue&&_stylesheet.clearHighlightStyle(_contentScript.highlightClassName),c1.newValue&&_stylesheet.setHighlightStyle({className:_contentScript.highlightClassName,style:c1.newValue})}if(changes.highlightDefinitions){var c2=changes.highlightDefinitions;c2.oldValue&&c2.oldValue.forEach(function(h){_stylesheet.clearHighlightStyle(h.className)}),c2.newValue&&c2.newValue.forEach(function(h){_stylesheet.setHighlightStyle(h)})}changes.highlightBackgroundAlpha&&_contentScript.resetStylesheetHighlightStyle()}},resetStylesheetHighlightStyle:function(){"use strict";_storage.highlightDefinitions.getAll(function(result){result&&_contentScript.onStorageChanged({sharedHighlightStyle:{newValue:result.sharedHighlightStyle},highlightDefinitions:{newValue:result.highlightDefinitions}},"sync")})}};$().ready(function(){"use strict";_contentScript.init()});