var _contextMenus={hoveredHighlightId:null,setHoveredHighlightId:function(id){"use strict";_contextMenus.hoveredHighlightId=id,_contextMenus.recreateMenu()},getHoveredHighlightId:function(){"use strict";return _contextMenus.hoveredHighlightId},recreateMenu:function(){"use strict";_storage.highlightDefinitions.getAll(function(items){_contextMenus.hoveredHighlightId?_database.getDocument(_contextMenus.hoveredHighlightId,function(err,doc){doc&&_contextMenus._recreateMenu(items.highlightDefinitions,doc)}):_contextMenus._recreateMenu(items.highlightDefinitions)})},_recreateMenu:function(highlightDefinitions,doc){"use strict";if(chrome.contextMenus.removeAll(),doc&&"create"!==doc.verb)throw"Unknown verb: "+doc.verb;var parentId=chrome.contextMenus.create({id:"sos",title:chrome.runtime.getManifest().name,contexts:_contextMenus.hoveredHighlightId?["all"]:["selection"]});chrome.commands.getAll(function(commands){for(var i=0;i<highlightDefinitions.length;i++){var hd=highlightDefinitions[i],title=hd.title,shortcut=i<commands.length?commands[i].shortcut:null;shortcut&&shortcut.length>0&&(title+=" ["+shortcut+"]");var options={type:doc?"radio":"normal",id:(doc?"update_highlight.":"create_highlight.")+hd.className,parentId:parentId,title:title,contexts:doc?["all"]:["selection"]};doc&&(options.checked=doc.className===hd.className),chrome.contextMenus.create(options)}doc&&(chrome.contextMenus.create({id:"sep1",parentId:parentId,type:"separator",contexts:["all"]}),chrome.contextMenus.create({id:"select_highlight_text",parentId:parentId,title:chrome.i18n.getMessage("select_highlight_text"),contexts:["all"]}),chrome.contextMenus.create({id:"copy_highlight_text",parentId:parentId,title:chrome.i18n.getMessage("copy_highlight_text"),contexts:["all"]}),chrome.contextMenus.create({id:"speak_highlight_text",parentId:parentId,title:chrome.i18n.getMessage("speak_highlight_text"),contexts:["all"]}),chrome.contextMenus.create({id:"sep2",parentId:parentId,type:"separator",contexts:["all"]}),chrome.contextMenus.create({id:"delete_highlight",parentId:parentId,title:chrome.i18n.getMessage("delete_highlight"),contexts:["all"]}))})},onClicked:function(info,tab){"use strict";var re=new RegExp("^(.+)\\.(.+)"),match=re.exec(info.menuItemId);if(match&&3===match.length){var className=match[2];switch(match[1]){case"create_highlight":if(info.editable)return void window.alert(chrome.i18n.getMessage("alert_create_highlight_in_editable"));if(info.frameUrl&&info.frameUrl!==tab.url)return void window.alert(chrome.i18n.getMessage("alert_create_highlight_in_subframe"));_tabs.sendGetSelectionRangeMessage(tab.id,function(xpathRange){xpathRange&&!xpathRange.collapsed&&(_eventPage.createHighlight(tab.id,xpathRange,_database.buildMatchString(tab.url,info.frameUrl),info.selectionText,className),_storage.getUnselectAfterHighlight(function(unselectAfterHighlight){unselectAfterHighlight&&_eventPage.selectHighlightText(tab.id)}))});break;case"update_highlight":_contextMenus.hoveredHighlightId&&_eventPage.updateHighlight(tab.id,_contextMenus.hoveredHighlightId,className);break;default:throw"Unhandled menu item id: "+info.menuItemId}}else switch(info.menuItemId){case"select_highlight_text":_contextMenus.hoveredHighlightId&&_eventPage.selectHighlightText(tab.id,_contextMenus.hoveredHighlightId);break;case"copy_highlight_text":_contextMenus.hoveredHighlightId&&_eventPage.copyHighlightText(_contextMenus.hoveredHighlightId);break;case"speak_highlight_text":_contextMenus.hoveredHighlightId&&_eventPage.speakHighlightText(_contextMenus.hoveredHighlightId);break;case"delete_highlight":_contextMenus.hoveredHighlightId&&_eventPage.deleteHighlight(tab.id,_contextMenus.hoveredHighlightId);break;default:throw"Unhandled menu item. id="+info.menuItemId}}};