var _database={db:null,getDatabase:function(){"use strict";return _database.db||(_database.db=new PouchDB("sos")),_database.db},putDesignDocuments:function(callback){"use strict";_database.getDatabase().bulkDocs([{_id:"_design/match_date_view",views:{match_date_view:{map:function(doc){doc.match&&emit([doc.match,doc.date])}.toString()}}},{_id:"_design/sum_view",views:{sum_view:{map:function(doc){switch(doc.verb){case"create":emit(doc.match,1);break;case"delete":emit(doc.match,-1)}}.toString(),reduce:"_sum"}}}],callback)},resetDatabase:function(callback){"use strict";_database.getDatabase().destroy(function(err){return err?void(callback&&callback(err)):(_database.db=null,_database.getDatabase(),void _database.putDesignDocuments(callback))})},buildMatchString:function(pageUrl,frameUrl,options){"use strict";var u=purl(pageUrl),host=u.attr("host");if(options||options||(options={scheme:!0,query:!0,fragment:!1}),options.scheme&&options.query&&options.fragment)return pageUrl;var port=u.attr("port"),query=u.attr("query"),fragment=u.attr("fragment"),match=options.scheme?u.attr("protocol")+"://":"";return match+=host,port&&0!==port.length&&(match+=":"+port),match+=u.attr("path"),options.query&&query&&0!==query.length&&(match+="?"+query),options.fragment&&fragment&&0!==fragment.length&&(match+="#"+fragment),match},postCreateDocument:function(match,range,className,text,callback){"use strict";_database.getDatabase().put({match:match,date:Date.now(),verb:"create",range:range,className:className,text:text},_stringUtils.createUUID({beginWithLetter:!0}),callback)},postDeleteDocument:function(documentId,callback){"use strict";_database.getDocument(documentId,function(err,doc){if(err)return void(callback&&callback(err));var match=doc.match;_database.getDatabase().post({match:match,date:Date.now(),verb:"delete",correspondingDocumentId:documentId},callback)})},updateCreateDocument:function(documentId,className,callback){"use strict";_database.getDocument(documentId,function(err,doc){return err?void(callback&&callback(err)):"create"!==doc.verb?void(callback&&callback({message:"Attempted to update document with unhandled verb: "+doc.verb})):doc.className===className?void(callback&&callback(null,doc)):(doc.className=className,void _database.getDatabase().put(doc,callback))})},getDocument:function(documentId,callback){"use strict";_database.getDatabase().get(documentId,callback)},getDocuments:function(match,callback){"use strict";_database.getDatabase().query("match_date_view",{startkey:[match],endkey:[match,{}],descending:!1,include_docs:!0},function(err,result){if(callback)if(err)callback(err);else{var docs=result.rows.map(function(row){return row.doc});callback(null,docs)}})},removeDocument:function(id,rev,callback){"use strict";callback||(callback=function(){}),_database.getDatabase().remove(id,rev,callback)},removeDocuments:function(match,callback){"use strict";_database.getDocuments(match,function(err,docs){return err?void(callback&&callback(err)):(docs.forEach(function(doc){doc._deleted=!0}),void _database.getDatabase().bulkDocs(docs,callback))})},getMatchSum:function(match,callback){"use strict";_database.getDatabase().query("sum_view",{key:match},function(err,result){if(callback)if(err)callback(err);else{var sum=result.rows[0].value;callback(null,sum)}})},getMatchSums:function(callback){"use strict";_database.getDatabase().query("sum_view",{group:!0,group_level:1,include_docs:!1},function(err,result){err?callback(err):callback(null,result.rows)})},getCreateDocuments:function(match,callback){"use strict";_database.getDocuments(match,function(err,docs){if(callback){if(err)return void callback(err);var filterable={};docs=docs.filter(function(doc){return"delete"===doc.verb?(filterable[doc.correspondingDocumentId]=!0,!1):!0}).filter(function(doc){return void 0===filterable[doc._id]}),callback(null,docs)}})},viewCleanup:function(callback){"use strict";_database.getDatabase().viewCleanup(callback)},compact:function(callback){"use strict";_database.getDatabase().compact(callback)}};